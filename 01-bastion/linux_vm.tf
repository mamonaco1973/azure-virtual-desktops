# -------------------------------------------------------------------------------------------------
# CREATE A NETWORK INTERFACE (NIC) FOR THE VIRTUAL MACHINE TO ATTACH TO THE VIRTUAL NETWORK
# -------------------------------------------------------------------------------------------------
resource "azurerm_network_interface" "linux-vm-nic" {
  name                = "linux-vm-nic"                           # Name of the NIC resource in Azure
  location            = var.project_location                     # Must match the region of the resource group
  resource_group_name = azurerm_resource_group.project_rg.name   # Reference to the existing resource group

  # -----------------------------
  # CONFIGURE IP SETTINGS FOR NIC
  # -----------------------------
  ip_configuration {
    name                          = "internal"                    # Internal identifier for this IP config
    subnet_id                     = azurerm_subnet.vm-subnet.id   # Attach NIC to a specific subnet (MUST EXIST)
    private_ip_address_allocation = "Dynamic"                     # Let Azure auto-assign a private IP
  }
}

# -------------------------------------------------------------------------------------------------
# CREATE A LINUX VIRTUAL MACHINE AND ASSOCIATE IT WITH THE NIC DEFINED ABOVE
# -------------------------------------------------------------------------------------------------
resource "azurerm_linux_virtual_machine" "linux-vm" {
  name                = "linux-vm"                                # Name of the VM shown in Azure Portal
  location            = var.project_location                      # Must match location of NIC and RG
  resource_group_name = azurerm_resource_group.project_rg.name    # Same resource group as NIC

  size                = "Standard_B1s"                            # VM size (1 vCPU, 1 GB RAM â€” barebones)
  admin_username      = "sysadmin"                                # Login username (SSH or password)
  admin_password      = random_password.vm_password.result        # Secure password generated by random_password resource

  disable_password_authentication = false                         # REQUIRED if using password auth; set true for SSH-only

  # ----------------------------------------
  # ATTACH THE VM TO THE NETWORK INTERFACE(S)
  # ----------------------------------------
  network_interface_ids = [
     azurerm_network_interface.linux-vm-nic.id                   # Link the previously defined NIC
  ]

  # --------------------------
  # CONFIGURE THE OS DISK
  # --------------------------
  os_disk {
    caching              = "ReadWrite"                            # Enable disk caching (improves performance)
    storage_account_type = "Standard_LRS"                         # Use Standard Locally Redundant Storage (cheaper, slower)
  }

  # ------------------------------------------
  # SPECIFY UBUNTU IMAGE FROM AZURE MARKETPLACE
  # ------------------------------------------
  source_image_reference {
    publisher = "canonical"                                       # Canonical = Ubuntu maintainer
    offer     = "ubuntu-24_04-lts"                                # Offer = Ubuntu 24.04 LTS release
    sku       = "server"                                          # Server edition
    version   = "latest"                                          # Always pull the latest available image
  }
}
